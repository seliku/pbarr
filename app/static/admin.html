<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBArr Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .version {
            color: #666;
            font-size: 14px;
        }
        
        .grid {
            column-count: 2;
            column-gap: 20px;
            margin-bottom: 20px;
        }

        .grid .card {
            break-inside: avoid;
            margin-bottom: 20px;
        }

        /* Series Management Layout */
        .series-management-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .series-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .series-management-container .card {
            margin-bottom: 0;
        }

        .series-item {
            break-inside: avoid;
        }

        .logs-container {
            background: #1e1e1e;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .log-line {
            margin-bottom: 2px;
            padding: 2px 0;
        }

        .log-level-INFO { color: #50fa7b; }
        .log-level-WARNING { color: #ffb86c; }
        .log-level-ERROR { color: #ff5555; }
        .log-level-DEBUG { color: #6272a4; }

        .log-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-controls select,
        .log-controls input {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .log-status {
            font-size: 11px;
            color: #666;
            margin-left: auto;
        }

        .log-status.active {
            color: #28a745;
        }

        .log-status.error {
            color: #dc3545;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .config-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .config-item.editing {
            background: #fff9e6;
            border-left-color: #ffc107;
        }
        
        .config-key {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .config-description {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .config-value-display {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            color: #666;
            word-break: break-all;
            margin-bottom: 5px;
        }
        
        .config-value-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .config-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .tag.secret {
            background: #e74c3c;
        }
        
        .module-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .module-info {
            flex: 1;
        }
        
        .module-name {
            font-weight: 600;
            color: #333;
        }
        
        .module-type {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .module-status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            margin-right: 5px;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .error-box {
            background-color: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .error-box h4 {
            color: #c33;
            margin-top: 0;
        }

        .error-message {
            color: #c33;
            margin: 5px 0;
            font-size: 14px;
        }

        .steps-log {
            margin: 20px 0;
        }

        .step-item {
            display: flex;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .step-item.success {
            background-color: #efe;
            border-left: 4px solid #0c0;
        }

        .step-item.error {
            background-color: #fee;
            border-left: 4px solid #c33;
        }

        .status-icon {
            font-weight: 600;
            min-width: 20px;
            margin-right: 10px;
        }

        .step-content {
            flex: 1;
        }

        .success-message {
            color: #0c0;
            font-weight: 600;
            padding: 10px;
            background: #efe;
            border-radius: 4px;
        }

        .error-message {
            color: #c33;
            font-weight: 600;
            padding: 10px;
            background: #fee;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-actions">
                <button class="btn btn-danger" onclick="restartContainer()" title="Container neu starten">üîÑ Container neu starten</button>
            </div>
            <h1>üé¨ PBArr Admin Panel</h1>
            <p class="version">Version: <span id="version">-</span></p>
            <p class="version" style="margin-top: 5px;">Status: <span id="status" style="color: #28a745; font-weight: bold;">‚úì Online</span></p>
        </header>
        

        
        <!-- Series Management - Full Width Container -->
        <div class="series-management-container">
            <div class="card">
                <h2>üì∫ Serien-Verwaltung</h2>
                <div id="series-loading" class="loading">Lade Serien...</div>
                <div class="series-grid" id="series-list">
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Network Configuration -->
            <div class="card">
                <h2>üåê Netzwerk</h2>
                <div id="network-loading" class="loading">Lade Netzwerk-Konfiguration...</div>
                <div id="network-list"></div>
                <div id="network-message" style="margin-top: 10px;"></div>

                <!-- SOCKS5 Proxy Toggle Section -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <h3 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">üîí SOCKS5 Proxy Routing</h3>
                    <p style="margin: 0 0 15px 0; font-size: 14px; color: #6c757d;">
                        Aktiviert/Deaktiviert systemweites SOCKS5 Proxy Routing f√ºr alle TCP-Verbindungen.
                        Lokaler Traffic (LAN, Docker-Netzwerke) wird immer direkt geroutet.
                    </p>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-weight: 600; color: #495057;">Status:</label>
                            <span id="socks5-status" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">Lade...</span>
                        </div>
                        <button id="socks5-toggle-btn" class="btn" onclick="toggleSocks5Proxy()" style="display: none;">
                            üîÑ Aktiviere Proxy
                        </button>
                    </div>
                    <div id="socks5-config-section" style="margin-top: 15px; display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #495057;">Host:</label>
                                <input type="text" id="socks5-host" placeholder="proxy.example.com" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #495057;">Port:</label>
                                <input type="number" id="socks5-port" placeholder="1080" value="1080" min="1" max="65535" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #495057;">Benutzername:</label>
                                <input type="text" id="socks5-user" placeholder="username" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #495057;">Passwort:</label>
                            <input type="text" id="socks5-pass" placeholder="password" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveSocks5Config()" style="font-size: 13px; padding: 6px 12px;">üíæ Speichern und Neustarten</button>
                            <button class="btn btn-secondary" onclick="cancelSocks5Config()" style="font-size: 13px; padding: 6px 12px;">‚úó Abbrechen</button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                        <strong>‚ÑπÔ∏è Hinweis:</strong> √Ñnderungen erfordern einen Container-Neustart (<code>docker compose restart pbarr</code>)
                    </div>
                </div>
            </div>

            <!-- Downloads -->
            <div class="card">
                <h2>‚¨áÔ∏è Downloads</h2>
                <div id="downloads-loading" class="loading">Loading download settings...</div>
                <div id="downloads-list"></div>
            </div>

            <!-- Configuration -->
            <div class="card">
                <h2>‚öôÔ∏è Konfiguration</h2>
                <div id="config-loading" class="loading">Lade Konfiguration...</div>
                <div id="config-list"></div>
                <button class="btn btn-secondary" onclick="refreshConfigs()">üîÑ Aktualisieren</button>
                <button class="btn" onclick="openAddConfigModal()">‚ûï Konfiguration hinzuf√ºgen</button>
            </div>

            <!-- Modules -->
            <div class="card">
                <h2>üîå Modules</h2>
                <div id="modules-loading" class="loading">Loading modules...</div>
                <div id="modules-list"></div>
            </div>

            <!-- Sonarr Integration Setup -->
            <div class="card">
                <h2>üì∫ Sonarr Webhook Integration</h2>
                <p style="color: #666; margin-bottom: 15px;">Webhook-basierte Integration f√ºr automatische Serien-Erkennung</p>

                <!-- Manual Cache Sync Button (only shown when webhook is configured) -->
                <div id="manual-cache-sync-container" style="display: none; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="triggerManualCacheSync()" id="manual-cache-sync-btn">
                        üîÑ Mediathek-Cache aktualisieren
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Startet sofortige Suche nach neuen Episoden und pr√ºft auf Monitoring-√Ñnderungen
                    </div>
                </div>

                <!-- Manual Import Scan Button (only shown when webhook is configured) -->
                <div id="manual-import-scan-container" style="display: none; margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="triggerManualImportScan()" id="manual-import-scan-btn">
                        üì• Sonarr Import-Scan starten
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Synchronisiert PBArr-Watchlist mit Sonarr-Serien die den 'pbarr'-Tag haben
                    </div>
                </div>

                <!-- Status Box -->
                <div id="sonarr-status-box" class="success" style="display: none; margin-bottom: 15px;">
                    <div id="sonarr-status-message"></div>
                </div>

                <!-- Error Box - INSIDE the component! -->
                <div id="sonarr-error-box" class="error-box" style="display: none;">
                    <h4>Fehler</h4>
                    <div id="sonarr-errors"></div>
                </div>

                <div id="sonarr-setup-form">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Sonarr URL:</label>
                        <input type="text" id="sonarr-url" placeholder="http://sonarr:8989" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Sonarr API Key:</label>
                        <input type="text" id="sonarr-api-key" placeholder="Dein Sonarr API-Key" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">PBArr URL:</label>
                        <input type="text" id="pbarr-url" placeholder="http://pbarr:8000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="display: block; color: #666; font-size: 12px; margin-top: 5px;">
                            Die URL, unter der PBArr erreichbar ist (f√ºr Webhooks)
                        </small>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px;">
                        <strong style="color: #004085;">üìÅ Download-Pfad:</strong>
                        <div style="margin-top: 5px; font-size: 14px; color: #004085;">
                            Downloads werden automatisch in <code style="background: #fff; padding: 2px 4px; border-radius: 3px;">/app/downloads/completed</code> gespeichert
                        </div>
                        <small style="display: block; color: #666; font-size: 12px; margin-top: 5px;">
                            Dieses Verzeichnis ist in docker-compose.yml auf deinen Host gemappt
                        </small>
                    </div>

                    <button class="btn" onclick="testSonarrConnection()" id="test-btn" style="margin-right: 10px;">üîç Testen & Speichern</button>
                    <button class="btn" onclick="startSonarrSetup()" id="setup-btn" disabled>üöÄ Setup starten</button>
                </div>

                <div id="sonarr-setup-progress" style="display: none; margin-top: 15px;">
                    <h3>‚öôÔ∏è Setup wird ausgef√ºhrt...</h3>
                    <div id="setup-steps"></div>
                </div>

                <div id="sonarr-setup-result" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="card">
            <h2>üìã System Logs</h2>
            <div class="log-controls">
                <select id="log-lines" onchange="loadLogs()">
                    <option value="50">50 lines</option>
                    <option value="100" selected>100 lines</option>
                    <option value="200">200 lines</option>
                    <option value="500">500 lines</option>
                </select>
                <select id="log-level-select" onchange="changeLogLevel()">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <button class="btn btn-small" onclick="loadLogs()">üîÑ Refresh</button>
                <button class="btn btn-small" id="stream-toggle" onclick="toggleStreaming()">‚ñ∂Ô∏è Start Live</button>
                <span class="log-status" id="stream-status">Stream: Stopped</span>
            </div>
            <div id="logs-container" class="logs-container">Loading logs...</div>
        </div>

        <!-- System Section -->
        <div class="card" style="margin-top: 20px;">
            <h2>üîß System</h2>
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <span style="font-weight: 600; color: #333;">Version:</span>
                <span id="system-version" style="margin-left: 10px; color: #666;">-</span>
            </div>
            <button class="btn" onclick="checkUpdates()">Check for Updates</button>
            <button class="btn btn-secondary" onclick="refreshAll()" style="margin-left: 10px;">Refresh All</button>
            <a href="/static/sonarr_integration.md" class="btn" style="margin-left: 10px; background: #28a745;">üì∫ Sonarr Integration Guide</a>
            <div id="system-message" style="margin-top: 10px;"></div>
        </div>
    </div>
    
    <!-- Add Config Modal -->
    <div id="addConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Add New Configuration</div>
            <form onsubmit="saveNewConfig(event)">
                <div class="form-group">
                    <label>Key:</label>
                    <input type="text" id="newConfigKey" required>
                </div>
                <div class="form-group">
                    <label>Value:</label>
                    <textarea id="newConfigValue" required></textarea>
                </div>
                <div class="form-group">
                    <label>Module:</label>
                    <input type="text" id="newConfigModule" value="core">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newConfigSecret">
                        Is Secret?
                    </label>
                </div>
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addConfigModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Edit Series Filters Modal -->
    <div id="editSeriesFiltersModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Serien-Filter bearbeiten</div>
            <div id="series-filters-form">
                <div class="form-group">
                    <label>Serie:</label>
                    <div id="series-title-display" style="font-weight: bold; padding: 8px; background: #f0f0f0; border-radius: 4px;"></div>
                </div>
                <div class="form-group">
                    <label for="min-duration">Mindestdauer (Minuten):</label>
                    <input type="number" id="min-duration" placeholder="0" min="0">
                    <small style="color: #666; font-size: 12px;">Episoden k√ºrzer als dieser Wert werden ignoriert (Default: 0 = alle)</small>
                </div>
                <div class="form-group">
                    <label for="max-duration">Maximale Dauer (Minuten):</label>
                    <input type="number" id="max-duration" placeholder="360" min="0">
                    <small style="color: #666; font-size: 12px;">Episoden l√§nger als dieser Wert werden ignoriert (Default: 360 Minuten)</small>
                </div>
                <div class="form-group">
                    <label for="exclude-keywords">Auszuschlie√üende Schl√ºsselw√∂rter:</label>
                    <textarea id="exclude-keywords" rows="3">klare Sprache,Audiodeskription,Geb√§rdensprache</textarea>
                    <small style="color: #666; font-size: 12px;">Kommagetrennte Schl√ºsselw√∂rter. Episoden mit diesen W√∂rtern werden ausgeschlossen</small>
                </div>
                <div class="form-group">
                    <label for="include-senders">Einzuschlie√üende Sender:</label>
                    <textarea id="include-senders" placeholder="" rows="3"></textarea>
                    <small style="color: #666; font-size: 12px;">Kommagetrennte Sender. Nur Episoden von diesen Sendern werden eingeschlossen (leer lassen f√ºr alle)</small>
                </div>
                <button class="btn btn-success" onclick="saveSeriesFilters()">Filter speichern</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('editSeriesFiltersModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Add Series Modal -->
    <div id="addSeriesModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Add New Series</div>
            <form onsubmit="addNewSeries(event)">
                <div class="form-group">
                    <label for="new-series-tvdb-id">TVDB ID:</label>
                    <input type="text" id="new-series-tvdb-id" placeholder="e.g. 12345" required>
                    <small style="color: #666; font-size: 12px;">The TVDB ID of the series</small>
                </div>
                <div class="form-group">
                    <label for="new-series-title">Series Title (optional):</label>
                    <input type="text" id="new-series-title" placeholder="Will be fetched from TVDB if empty">
                    <small style="color: #666; font-size: 12px;">Leave empty to auto-fetch from TVDB</small>
                </div>
                <button type="submit" class="btn btn-success">Add Series</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('addSeriesModal')">Cancel</button>
            </form>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin;
        
        async function fetchJSON(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }
        
        async function fetchWithMethod(url, method, body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }
        
        async function loadDashboard() {
            try {
                const data = await fetchJSON(`${API_URL}/admin/dashboard`);
                document.getElementById('config-count').textContent = data.config_items;
                document.getElementById('modules-enabled').textContent = data.modules.enabled;
                document.getElementById('modules-total').textContent = data.modules.total;
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }
        
        async function loadVersion() {
            try {
                const data = await fetchJSON(`${API_URL}/api/system/version`);
                document.getElementById('version').textContent = data.version;
                document.getElementById('system-version').textContent = data.version;
            } catch (error) {
                console.error('Version error:', error);
            }
        }
        
        async function loadConfigs() {
            const container = document.getElementById('config-list');
            const loading = document.getElementById('config-loading');
            
            try {
                const configs = await fetchJSON(`${API_URL}/admin/config`);
                loading.style.display = 'none';
                
                // Filter out configs that are controlled elsewhere
                const filteredConfigs = configs.filter(config =>
                    config.key !== 'log_level' &&
                    config.key !== 'pbarr_url' &&
                    config.key !== 'sonarr_url' &&
                    config.key !== 'sonarr_api_key' &&
                    config.key !== 'sonarr_download_path_host' &&
                    config.key !== 'tvdb_api_key' &&
                    config.key !== 'mediathekviewweb_enabled' &&
                    config.key !== 'download_path' &&
                    config.key !== 'update_check_interval' &&
                    config.key !== 'download_retry_count' &&
                    config.key !== 'max_concurrent_downloads' &&
                    config.key !== 'socks5_proxy'
                );

                container.innerHTML = filteredConfigs.map(config => `
                    <div class="config-item" id="config-${config.id}">
                        <div class="config-key">${config.key}</div>
                        <div class="config-description">${config.description || ''}</div>
                        <div class="config-value-display" id="display-${config.id}">${config.value || '(empty)'}</div>
                        <div class="config-tags">
                            <span class="tag">${config.module}</span>
                            ${config.secret ? '<span class="tag secret">üîí Secret</span>' : ''}
                            <span class="tag" style="background: #999;">${config.data_type}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-small" onclick="editConfig(${config.id}, '${config.key}')">‚úé Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteConfig('${config.key}')">üóë Delete</button>
                        </div>
                        <input type="text" class="config-value-input" id="input-${config.id}" style="display:none;" value="${config.value || ''}">
                        <div class="action-buttons" id="edit-buttons-${config.id}" style="display:none;">
                            <button class="btn btn-small btn-success" onclick="saveConfig(${config.id}, '${config.key}')">‚úì Save</button>
                            <button class="btn btn-small btn-secondary" onclick="cancelEdit(${config.id})">‚úó Cancel</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load configs: ${error.message}</div>`;
                loading.style.display = 'none';
            }
        }
        
        function editConfig(id, key) {
            document.getElementById(`display-${id}`).style.display = 'none';
            document.getElementById(`input-${id}`).style.display = 'block';
            document.getElementById(`edit-buttons-${id}`).style.display = 'flex';
            document.getElementById(`config-${id}`).classList.add('editing');
        }
        
        function cancelEdit(id) {
            document.getElementById(`display-${id}`).style.display = 'block';
            document.getElementById(`input-${id}`).style.display = 'none';
            document.getElementById(`edit-buttons-${id}`).style.display = 'none';
            document.getElementById(`config-${id}`).classList.remove('editing');
        }
        
        async function saveConfig(id, key) {
            const newValue = document.getElementById(`input-${id}`).value;
            try {
                await fetchWithMethod(`${API_URL}/admin/config/${key}`, 'PUT', { value: newValue });
                document.getElementById(`display-${id}`).textContent = newValue || '(empty)';
                cancelEdit(id);
                showSuccess(`Config '${key}' updated!`);
            } catch (error) {
                showError(`Failed to save: ${error.message}`);
            }
        }
        
        async function deleteConfig(key) {
            if (!confirm(`Delete config '${key}'?`)) return;
            try {
                await fetchWithMethod(`${API_URL}/admin/config/${key}`, 'DELETE');
                showSuccess(`Config '${key}' deleted!`);
                loadConfigs();
            } catch (error) {
                showError(`Failed to delete: ${error.message}`);
            }
        }
        
        async function loadNetwork() {
            const container = document.getElementById('network-list');
            const loading = document.getElementById('network-loading');

            try {
                const configs = await fetchJSON(`${API_URL}/admin/config`);
                loading.style.display = 'none';

                container.innerHTML = `
                    <!-- IP Check Section -->
                    <div id="ip-check-result" style="display:none; margin-top: 15px; padding: 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 5px;">
                        <div><strong>üìç Deine IP (direkt):</strong> <code id="direct-ip">-</code></div>
                        <div><strong>üõ°Ô∏è IP √ºber Proxy:</strong> <code id="proxied-ip">-</code></div>
                        <div><strong>‚úÖ Status:</strong> <span id="proxy-status">-</span></div>
                        <div><strong>‚ö° Latenz:</strong> <span id="proxy-latency">-</span>ms</div>
                    </div>
                    <button onclick="checkExternalIPs()">üîç IPs pr√ºfen</button>
                `;

                // Load SOCKS5 status
                await loadSocks5Status();
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load network settings: ${error.message}</div>`;
                loading.style.display = 'none';
            }
        }

        async function loadDownloads() {
            const container = document.getElementById('downloads-list');
            const loading = document.getElementById('downloads-loading');

            try {
                const configs = await fetchJSON(`${API_URL}/admin/config`);
                loading.style.display = 'none';

                // Filter for download-specific configs
                const downloadConfigs = configs.filter(config =>
                    config.key === 'download_retry_count' || config.key === 'max_concurrent_downloads'
                );

                container.innerHTML = downloadConfigs.map(config => `
                    <div class="config-item" id="download-${config.id}">
                        <div class="config-description" style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 2px;">${config.description || ''}</div>
                        <div class="config-key" style="font-size: 11px; color: #888; margin-bottom: 5px;">${config.key === 'max_concurrent_downloads' ? 'Maximale Anzahl gleichzeitiger Downloads' : config.key === 'download_retry_count' ? 'Anzahl der Versuche bei fehlgeschlagenen Downloads' : config.key}</div>
                        <div class="config-value-display" id="download-display-${config.id}">${config.value || '(empty)'}</div>
                        <div class="config-tags">
                            <span class="tag">${config.module}</span>
                            ${config.secret ? '<span class="tag secret">üîí Secret</span>' : ''}
                            <span class="tag" style="background: #999;">${config.data_type}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-small" onclick="editDownloadConfig(${config.id}, '${config.key}')">‚úé Edit</button>
                        </div>
                        <input type="text" class="config-value-input" id="download-input-${config.id}" style="display:none;" value="${config.value || ''}">
                        <div class="action-buttons" id="download-edit-buttons-${config.id}" style="display:none;">
                            <button class="btn btn-small btn-success" onclick="saveDownloadConfig(${config.id}, '${config.key}')">‚úì Save</button>
                            <button class="btn btn-small btn-secondary" onclick="cancelDownloadEdit(${config.id})">‚úó Cancel</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load download settings: ${error.message}</div>`;
                loading.style.display = 'none';
            }
        }

        function editDownloadConfig(id, key) {
            document.getElementById(`download-display-${id}`).style.display = 'none';
            document.getElementById(`download-input-${id}`).style.display = 'block';
            document.getElementById(`download-edit-buttons-${id}`).style.display = 'flex';
            document.getElementById(`download-${id}`).classList.add('editing');
        }

        function cancelDownloadEdit(id) {
            document.getElementById(`download-display-${id}`).style.display = 'block';
            document.getElementById(`download-input-${id}`).style.display = 'none';
            document.getElementById(`download-edit-buttons-${id}`).style.display = 'none';
            document.getElementById(`download-${id}`).classList.remove('editing');
        }

        async function saveDownloadConfig(id, key) {
            const newValue = document.getElementById(`download-input-${id}`).value;
            try {
                await fetchWithMethod(`${API_URL}/admin/config/${key}`, 'PUT', { value: newValue });
                document.getElementById(`download-display-${id}`).textContent = newValue || '(empty)';
                cancelDownloadEdit(id);
                showSuccess(`Download config '${key}' updated!`);
            } catch (error) {
                showError(`Failed to save: ${error.message}`);
            }
        }

        async function loadModules() {
            const container = document.getElementById('modules-list');
            const loading = document.getElementById('modules-loading');

            try {
                const modules = await fetchJSON(`${API_URL}/admin/modules`);
                const configs = await fetchJSON(`${API_URL}/admin/config`);
                loading.style.display = 'none';

                container.innerHTML = modules.map(module => {
                    let configHtml = '';
                    let moduleDescription = '';

                    // Add module-specific configs and descriptions
                    if (module.module_name === 'scheduler') {
                        moduleDescription = 'Automatische Tasks: Update-Checks t√§glich um 3 Uhr, Download-Queue jede Minute';
                    } else if (module.module_name === 'tvdb') {
                        const tvdbKey = configs.find(c => c.key === 'tvdb_api_key');
                        if (tvdbKey) {
                            configHtml = `
                                <div style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">TVDB API Key:</div>
                                    <input type="text" id="tvdb-api-key-${module.module_name}" value="${tvdbKey.value || ''}" placeholder="Enter TVDB API Key"
                                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                                    <button class="btn btn-small" style="margin-top: 5px;" onclick="saveTVDBKey('${module.module_name}')">üíæ Speichern</button>
                                </div>
                            `;
                        }
                    } else if (module.module_name === 'mediathekviewweb') {
                        const enabled = configs.find(c => c.key === 'mediathekviewweb_enabled');
                        if (enabled) {
                            configHtml = `
                                <div style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                    <label style="display: flex; align-items: center; font-size: 12px; color: #666;">
                                        <input type="checkbox" ${enabled.value === 'true' ? 'checked' : ''}
                                               onchange="updateModuleConfig('mediathekviewweb_enabled', this.checked ? 'true' : 'false')"
                                               style="margin-right: 8px;">
                                        MediathekViewWeb aktivieren
                                    </label>
                                </div>
                            `;
                        }
                    }

                    return `
                        <div class="module-item">
                            <div class="module-info">
                                <div class="module-name">${module.module_name}</div>
                                <div class="module-type">${module.module_type} ‚Ä¢ v${module.version}</div>
                                ${moduleDescription ? `<div style="font-size: 11px; color: #888; margin-top: 4px;">${moduleDescription}</div>` : ''}
                                ${configHtml}
                            </div>
                            <span class="module-status ${module.enabled ? 'status-enabled' : 'status-disabled'}" onclick="toggleModule('${module.module_name}', ${!module.enabled})">
                                ${module.enabled ? '‚úì Enabled' : '‚úó Disabled'}
                            </span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load modules: ${error.message}</div>`;
                loading.style.display = 'none';
            }
        }
        
        async function toggleModule(name, enabled) {
            try {
                await fetchWithMethod(`${API_URL}/admin/modules/${name}/toggle?enabled=${enabled}`, 'PUT');
                showSuccess(`Module '${name}' ${enabled ? 'enabled' : 'disabled'}!`);
                loadModules();
            } catch (error) {
                showError(`Failed to toggle module: ${error.message}`);
            }
        }

        async function updateModuleConfig(key, value) {
            try {
                await fetchWithMethod(`${API_URL}/admin/config/${key}`, 'PUT', { value: value });
                showSuccess(`Module config '${key}' updated!`);
            } catch (error) {
                showError(`Failed to update module config: ${error.message}`);
            }
        }

        async function saveTVDBKey(moduleName) {
            const input = document.getElementById(`tvdb-api-key-${moduleName}`);
            const value = input.value.trim();
            try {
                await fetchWithMethod(`${API_URL}/admin/config/tvdb_api_key`, 'PUT', { value: value });
                showSuccess(`TVDB API Key gespeichert!`);
            } catch (error) {
                showError(`Fehler beim Speichern: ${error.message}`);
            }
        }
        
        async function checkUpdates() {
            const msg = document.getElementById('system-message');
            msg.innerHTML = '<div class="loading">Checking for updates...</div>';
            
            try {
                await fetch(`${API_URL}/api/system/check-updates`, { method: 'POST' });
                msg.innerHTML = '<div class="success">‚úì Update check started in background</div>';
                
                setTimeout(async () => {
                    const status = await fetchJSON(`${API_URL}/api/system/update-status`);
                    if (status.update_available) {
                        msg.innerHTML = `<div class="success">‚úì Update available: ${status.latest}</div>`;
                    } else {
                        msg.innerHTML = '<div class="success">‚úì You are up to date</div>';
                    }
                }, 2000);
            } catch (error) {
                msg.innerHTML = `<div class="error">‚úó Update check failed: ${error.message}</div>`;
            }
        }
        
        function refreshConfigs() {
            document.getElementById('config-loading').style.display = 'block';
            document.getElementById('config-list').innerHTML = '';
            loadConfigs();
        }
        
        function refreshModules() {
            document.getElementById('modules-loading').style.display = 'block';
            document.getElementById('modules-list').innerHTML = '';
            loadModules();
        }
        
        function refreshAll() {
            loadDashboard();
            loadVersion();
            refreshConfigs();
            refreshModules();
        }
        
        function openAddConfigModal() {
            document.getElementById('addConfigModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        async function saveNewConfig(event) {
            event.preventDefault();
            const key = document.getElementById('newConfigKey').value;
            const value = document.getElementById('newConfigValue').value;
            const module = document.getElementById('newConfigModule').value;
            const secret = document.getElementById('newConfigSecret').checked;
            
            try {
                await fetchWithMethod(`${API_URL}/admin/config`, 'POST', {
                    key, value, module, secret,
                    data_type: 'string',
                    description: ''
                });
                showSuccess(`Config '${key}' created!`);
                closeModal('addConfigModal');
                refreshConfigs();
                // Reset form
                document.querySelector('#addConfigModal form').reset();
            } catch (error) {
                showError(`Failed to create config: ${error.message}`);
            }
        }
        
        function showSuccess(msg, containerId = null) {
            if (containerId) {
                // Show in specific container
                const container = document.getElementById(containerId);
                if (container) {
                    // Remove existing messages
                    const existing = container.querySelector('.message-alert');
                    if (existing) existing.remove();

                    const div = document.createElement('div');
                    div.className = 'success message-alert';
                    div.textContent = msg;
                    container.appendChild(div);
                    setTimeout(() => div.remove(), 3000);
                    return;
                }
            }

            // Fallback to global
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = msg;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 3000);
        }

        function showError(msg, containerId = null) {
            if (containerId) {
                // Show in specific container
                const container = document.getElementById(containerId);
                if (container) {
                    // Remove existing messages
                    const existing = container.querySelector('.message-alert');
                    if (existing) existing.remove();

                    const div = document.createElement('div');
                    div.className = 'error message-alert';
                    div.textContent = msg;
                    container.appendChild(div);
                    setTimeout(() => div.remove(), 5000);
                    return;
                }
            }

            // Fallback to global
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = msg;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 5000);
        }

        // Logs functionality
        let logStream = null;
        let isStreaming = false;

        async function loadCurrentLogLevel() {
            try {
                const config = await fetchJSON(`${API_URL}/admin/config/log_level`);
                const select = document.getElementById('log-level-select');
                select.value = config.value || 'INFO';
            } catch (error) {
                console.error('Failed to load current log level:', error);
                // Default to INFO if can't load
                document.getElementById('log-level-select').value = 'INFO';
            }
        }

        async function changeLogLevel() {
            const select = document.getElementById('log-level-select');
            const newLevel = select.value;

            try {
                await fetchWithMethod(`${API_URL}/admin/config/log_level`, 'PUT', { value: newLevel });
                showSuccess(`Log level changed to ${newLevel}!`);
            } catch (error) {
                showError(`Failed to change log level: ${error.message}`);
                // Revert selection on error
                loadCurrentLogLevel();
            }
        }

        async function loadLogs() {
            const container = document.getElementById('logs-container');
            const lines = document.getElementById('log-lines').value;

            try {
                container.textContent = 'Loading logs...';
                const data = await fetchJSON(`${API_URL}/admin/logs?lines=${lines}`);

                if (data.logs && data.logs.length > 0) {
                    container.innerHTML = data.logs.map(log => {
                        const level = extractLogLevel(log);
                        return `<div class="log-line log-level-${level}">${escapeHtml(log)}</div>`;
                    }).join('');
                    // Auto-scroll to bottom
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.textContent = 'No logs found.';
                }
            } catch (error) {
                container.textContent = `Error loading logs: ${error.message}`;
            }
        }

        function extractLogLevel(logLine) {
            // Extract log level from line like "2025-10-31 10:30:00 - app.main - INFO - ..."
            const match = logLine.match(/- (\w+) -/);
            return match ? match[1] : 'INFO';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function toggleStreaming() {
            const toggleBtn = document.getElementById('stream-toggle');
            const statusSpan = document.getElementById('stream-status');

            if (isStreaming) {
                // Stop streaming
                if (logStream) {
                    logStream.close();
                    logStream = null;
                }
                isStreaming = false;
                toggleBtn.textContent = '‚ñ∂Ô∏è Start Live';
                statusSpan.textContent = 'Stream: Stopped';
                statusSpan.classList.remove('active');
            } else {
                // Start streaming
                startLogStreaming();
                isStreaming = true;
                toggleBtn.textContent = '‚èπÔ∏è Stop Live';
                statusSpan.textContent = 'Stream: Active';
                statusSpan.classList.add('active');
            }
        }

        async function startLogStreaming() {
            try {
                const container = document.getElementById('logs-container');

                logStream = new EventSource(`${API_URL}/admin/logs/stream`);

                logStream.onmessage = (event) => {
                    if (event.data && event.data.trim()) {
                        const level = extractLogLevel(event.data);
                        const logElement = document.createElement('div');
                        logElement.className = `log-line log-level-${level}`;
                        logElement.textContent = event.data;

                        container.appendChild(logElement);

                        // Keep only last 1000 lines to prevent memory issues
                        while (container.children.length > 1000) {
                            container.removeChild(container.firstChild);
                        }

                        // Auto-scroll to bottom
                        container.scrollTop = container.scrollHeight;
                    }
                };

                logStream.onerror = (error) => {
                    console.error('Log streaming error:', error);
                    const statusSpan = document.getElementById('stream-status');
                    statusSpan.textContent = 'Stream: Error';
                    statusSpan.classList.remove('active');
                    statusSpan.classList.add('error');

                    // Auto-retry after 5 seconds
                    setTimeout(() => {
                        if (isStreaming) {
                            startLogStreaming();
                        }
                    }, 5000);
                };

                logStream.onopen = () => {
                    const statusSpan = document.getElementById('stream-status');
                    statusSpan.textContent = 'Stream: Connected';
                    statusSpan.classList.add('active');
                    statusSpan.classList.remove('error');
                };

            } catch (error) {
                console.error('Failed to start log streaming:', error);
                const statusSpan = document.getElementById('stream-status');
                statusSpan.textContent = 'Stream: Failed';
                statusSpan.classList.remove('active');
            }
        }

        // Sonarr Webhook Integration Setup
        async function testSonarrConnection() {
            const sonarrUrl = document.getElementById('sonarr-url').value.trim();
            const apiKey = document.getElementById('sonarr-api-key').value.trim();
            const pbarrUrl = document.getElementById('pbarr-url').value.trim();

            if (!sonarrUrl || !apiKey || !pbarrUrl) {
                showSonarrError(['Bitte alle Felder ausf√ºllen']);
                return;
            }

            // Clear previous errors
            hideSonarrError();

            try {
                const response = await fetch(`${API_URL}/admin/sonarr/test-connection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sonarr_url: sonarrUrl,
                        api_key: apiKey,
                        pbarr_url: pbarrUrl
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Enable setup button
                    document.getElementById('setup-btn').disabled = false;
                    document.getElementById('setup-btn').textContent = 'üöÄ Webhook einrichten';
                    showSonarrSuccess('‚úì Verbindung erfolgreich! Webhook kann eingerichtet werden.');
                } else {
                    showSonarrError([result.message]);
                }
            } catch (error) {
                showSonarrError([`Fehler beim Testen der Verbindung: ${error.message}`]);
            }
        }

        async function startSonarrSetup() {
            const sonarrUrl = document.getElementById('sonarr-url').value.trim();
            const apiKey = document.getElementById('sonarr-api-key').value.trim();
            const pbarrUrl = document.getElementById('pbarr-url').value.trim();

            if (!sonarrUrl || !apiKey || !pbarrUrl) {
                showSonarrError(['Bitte alle Felder ausf√ºllen']);
                return;
            }

            // Clear previous errors
            hideSonarrError();

            // Form ausblenden, Progress anzeigen
            document.getElementById('sonarr-setup-form').style.display = 'none';
            document.getElementById('sonarr-setup-progress').style.display = 'block';
            document.getElementById('sonarr-setup-result').innerHTML = '';

            try {
                const response = await fetch(`${API_URL}/admin/sonarr/webhook/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sonarr_url: sonarrUrl,
                        api_key: apiKey,
                        pbarr_url: pbarrUrl
                    })
                });

                const result = await response.json();

                // Progress ausblenden
                document.getElementById('sonarr-setup-progress').style.display = 'none';

                // Ergebnisse anzeigen
                if (result.success) {
                    // Success
                    const resultHtml = `
                        <div class="success-message">
                            ‚úÖ Webhook erfolgreich eingerichtet!
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 14px;">
                            <strong>Webhook-ID:</strong> ${result.webhook_id || 'N/A'}<br>
                            <strong>Verbindungstest:</strong> ${result.connection_test || 'Nicht durchgef√ºhrt'}
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            Wenn du jetzt eine Serie in Sonarr hinzuf√ºgst, wird PBArr automatisch benachrichtigt und beginnt mit der Mediathek-Cache-Erstellung.
                        </div>
                    `;
                    document.getElementById('sonarr-setup-result').innerHTML = resultHtml;

                    // Seite neu laden nach 5 Sekunden, um Status zu aktualisieren
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else {
                    // Error
                    showSonarrError([result.message]);
                    document.getElementById('sonarr-setup-form').style.display = 'block';
                }

            } catch (error) {
                document.getElementById('sonarr-setup-progress').style.display = 'none';
                showSonarrError([`Webhook-Setup-Fehler: ${error.message}`]);
                document.getElementById('sonarr-setup-form').style.display = 'block';
            }
        }

        function showSonarrError(errors) {
            const errorBox = document.getElementById('sonarr-error-box');
            const errorDiv = document.getElementById('sonarr-errors');
            errorDiv.innerHTML = errors.map(err => `<p class="error-message">${err}</p>`).join('');
            errorBox.style.display = 'block';
        }

        function hideSonarrError() {
            document.getElementById('sonarr-error-box').style.display = 'none';
        }

        function showSonarrSuccess(message) {
            const resultDiv = document.getElementById('sonarr-setup-result');
            resultDiv.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 3000);
        }

        // Manual Cache Sync Button
        async function triggerManualCacheSync() {
            const btn = document.getElementById('manual-cache-sync-btn');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'üîÑ Synchronisiere...';

                const response = await fetch(`${API_URL}/admin/trigger-cache-sync`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('‚úÖ Mediathek-Cache erfolgreich aktualisiert!');
                    // Reload logs to show new activity
                    loadLogs();
                } else {
                    showError(`‚ùå Cache-Sync fehlgeschlagen: ${result.error || 'Unbekannter Fehler'}`);
                }
            } catch (error) {
                showError(`‚ùå Cache-Sync-Fehler: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Manual Import Scan Button
        async function triggerManualImportScan() {
            const btn = document.getElementById('manual-import-scan-btn');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'üì• Scanne...';

                const response = await fetch(`${API_URL}/admin/trigger-import-scan`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('‚úÖ Sonarr Import-Scan erfolgreich gestartet!');
                    // Reload logs to show new activity
                    loadLogs();
                } else {
                    showError(`‚ùå Import-Scan fehlgeschlagen: ${result.message || 'Unbekannter Fehler'}`);
                }
            } catch (error) {
                showError(`‚ùå Import-Scan-Fehler: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Check Sonarr webhook integration status
        async function checkSonarrStatus() {
            try {
                const status = await fetchJSON(`${API_URL}/admin/sonarr/webhook/status`);

                const statusBox = document.getElementById('sonarr-status-box');
                const statusMessage = document.getElementById('sonarr-status-message');
                const setupBtn = document.getElementById('setup-btn');
                const manualCacheBtn = document.getElementById('manual-cache-sync-container');
                const manualImportBtn = document.getElementById('manual-import-scan-container');

                if (!status.config_complete) {
                    // Config incomplete - show warning
                    statusBox.className = 'error';
                    statusMessage.textContent = status.message;
                    statusBox.style.display = 'block';
                    setupBtn.disabled = true;
                    setupBtn.textContent = 'Konfiguration unvollst√§ndig';
                    manualCacheBtn.style.display = 'none'; // Hide manual cache button
                    manualImportBtn.style.display = 'none'; // Hide manual import button
                } else if (!status.connection_ok) {
                    // Connection failed - show error
                    statusBox.className = 'error';
                    statusMessage.textContent = status.message;
                    statusBox.style.display = 'block';
                    setupBtn.disabled = true;
                    setupBtn.textContent = 'Verbindung fehlgeschlagen';
                    manualCacheBtn.style.display = 'none'; // Hide manual cache button
                    manualImportBtn.style.display = 'none'; // Hide manual import button
                } else if (!status.setup_needed) {
                    // Webhook configured - show success and hide setup buttons, show manual buttons
                    statusBox.className = 'success';
                    statusMessage.textContent = status.message;
                    statusBox.style.display = 'block';
                    document.getElementById('test-btn').style.display = 'none';
                    setupBtn.style.display = 'none';
                    manualCacheBtn.style.display = 'block'; // Show manual cache button
                    manualImportBtn.style.display = 'block'; // Show manual import button

                    // Replace setup button with info message
                    if (!document.getElementById('sonarr-info-message')) {
                        const infoMessage = document.createElement('div');
                        infoMessage.id = 'sonarr-info-message';
                        infoMessage.style.cssText = 'margin-top: 10px; padding: 8px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px; font-size: 12px; color: #004085;';
                        infoMessage.textContent = 'Webhook ist aktiv. Bei neuen Serien in Sonarr wird PBArr automatisch benachrichtigt.';

                        // Replace the setup button with the info message
                        setupBtn.parentNode.replaceChild(infoMessage, setupBtn);
                    }
                } else {
                    // Webhook not configured - show warning (red) and show button
                    statusBox.className = 'error';  // Rot f√ºr "noch nicht konfiguriert"
                    statusMessage.textContent = status.message;
                    statusBox.style.display = 'block';
                    setupBtn.disabled = true; // Enable after successful test
                    setupBtn.textContent = 'üöÄ Webhook einrichten';
                    manualCacheBtn.style.display = 'none'; // Hide manual cache button
                    manualImportBtn.style.display = 'none'; // Hide manual import button
                }
            } catch (error) {
                console.error('Failed to check Sonarr webhook status:', error);
                // Show error but don't break the UI
                const statusBox = document.getElementById('sonarr-status-box');
                const statusMessage = document.getElementById('sonarr-status-message');
                statusBox.className = 'error';
                statusMessage.textContent = `Webhook-Status-Check fehlgeschlagen: ${error.message}`;
                statusBox.style.display = 'block';
                // Hide manual cache button on error
                document.getElementById('manual-cache-sync-container').style.display = 'none';
            }
        }

        // Load saved Sonarr config
        async function loadSonarrConfig() {
            try {
                const config = await fetchJSON(`${API_URL}/admin/sonarr/config`);

                // Fill form fields with saved values
                if (config.sonarr_url) {
                    document.getElementById('sonarr-url').value = config.sonarr_url;
                }
                if (config.sonarr_api_key) {
                    document.getElementById('sonarr-api-key').value = config.sonarr_api_key;
                }
                if (config.pbarr_url) {
                    document.getElementById('pbarr-url').value = config.pbarr_url;
                }
                // Note: sonarr_download_path is no longer configurable (hardcoded to /app/downloads)
            } catch (error) {
                console.error('Failed to load Sonarr config:', error);
                // Ignore errors - form will just be empty
            }
        }

        // Series Management Functions
        async function loadSeries() {
            const container = document.getElementById('series-list');
            const loading = document.getElementById('series-loading');

            try {
                const data = await fetchJSON(`${API_URL}/admin/series`);
                loading.style.display = 'none';

                if (data.series && data.series.length > 0) {
                    // Sort series alphabetically by title
                    const sortedSeries = data.series.sort((a, b) => a.title.localeCompare(b.title, 'de'));

                    container.innerHTML = sortedSeries.map(series => {
                        const filtersActive = (series.min_duration || series.max_duration || series.exclude_keywords || series.include_senders);
                        const filtersSummary = [];
                        if (series.min_duration) filtersSummary.push(`Min: ${series.min_duration}min`);
                        if (series.max_duration) filtersSummary.push(`Max: ${series.max_duration}min`);
                        if (series.exclude_keywords) filtersSummary.push(`Exclude: ${series.exclude_keywords.split(',').length} keywords`);
                        if (series.include_senders) filtersSummary.push(`Senders: ${series.include_senders.split(',').length}`);

                        return `
                            <div class="config-item" style="border-left-color: ${series.tagged_in_sonarr ? '#28a745' : '#667eea'};">
                                <div class="config-key">${series.title}</div>
                                <div class="config-description">
                                    TVDB: ${series.tvdb_id} ‚Ä¢ Episodes: ${series.episodes_found || 0} ‚Ä¢ Mediathek: ${series.mediathek_episodes_count || 0}
                                    ${series.sonarr_series_id ? ` ‚Ä¢ Sonarr: ${series.sonarr_series_id}` : ''}
                                </div>
                                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                    ${filtersActive ? `Filters: ${filtersSummary.join(' ‚Ä¢ ')}` : 'Keine Filter konfiguriert'}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-small" onclick="openEditSeriesFiltersModal('${series.tvdb_id}', '${series.title.replace(/'/g, "\\'")}', ${series.min_duration || 'null'}, ${series.max_duration || 'null'}, '${(series.exclude_keywords || '').replace(/'/g, "\\'")}', '${(series.include_senders || '').replace(/'/g, "\\'")}')">üéõÔ∏è Filter bearbeiten</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Keine Serien gefunden.</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load series: ${error.message}</div>`;
                loading.style.display = 'none';
            }
        }

        function openEditSeriesFiltersModal(tvdbId, title, minDuration, maxDuration, excludeKeywords, includeSenders) {
            // Store current series info
            window.currentSeriesTvdbId = tvdbId;

            // Fill modal
            document.getElementById('series-title-display').textContent = title;
            document.getElementById('min-duration').value = minDuration || '';
            document.getElementById('max-duration').value = maxDuration || '';
            document.getElementById('exclude-keywords').value = excludeKeywords || '';
            document.getElementById('include-senders').value = includeSenders || '';

            // Show modal
            document.getElementById('editSeriesFiltersModal').style.display = 'block';
        }

        async function saveSeriesFilters() {
            const tvdbId = window.currentSeriesTvdbId;
            const minDuration = document.getElementById('min-duration').value.trim();
            const maxDuration = document.getElementById('max-duration').value.trim();
            const excludeKeywords = document.getElementById('exclude-keywords').value.trim();
            const includeSenders = document.getElementById('include-senders').value.trim();

            try {
                const filters = {
                    min_duration: minDuration ? parseInt(minDuration) : null,
                    max_duration: maxDuration ? parseInt(maxDuration) : null,
                    exclude_keywords: excludeKeywords || null,
                    include_senders: includeSenders || null
                };

                const response = await fetch(`${API_URL}/admin/series/${tvdbId}/filters`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('‚úÖ Series filters updated successfully!');
                    closeModal('editSeriesFiltersModal');
                    refreshSeries();
                } else {
                    showError(`‚ùå Failed to update filters: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                showError(`‚ùå Error updating filters: ${error.message}`);
            }
        }



        function openAddSeriesModal() {
            document.getElementById('addSeriesModal').style.display = 'block';
        }

        async function addNewSeries(event) {
            event.preventDefault();

            const tvdbId = document.getElementById('new-series-tvdb-id').value.trim();
            const title = document.getElementById('new-series-title').value.trim();

            if (!tvdbId) {
                showError('‚ùå TVDB ID is required');
                return;
            }

            try {
                const seriesData = {
                    tvdb_id: tvdbId,
                    title: title || null
                };

                const response = await fetch(`${API_URL}/admin/series/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(seriesData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`‚úÖ Series "${result.series.title}" added to watchlist!`);
                    closeModal('addSeriesModal');
                    document.querySelector('#addSeriesModal form').reset();
                    refreshSeries();
                } else {
                    showError(`‚ùå Failed to add series: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                showError(`‚ùå Error adding series: ${error.message}`);
            }
        }

        function refreshSeries() {
            document.getElementById('series-loading').style.display = 'block';
            document.getElementById('series-list').innerHTML = '';
            loadSeries();
        }

        function refreshAll() {
            loadDashboard();
            loadVersion();
            refreshConfigs();
            refreshModules();
            refreshSeries();
            refreshNetwork();
        }

        function refreshNetwork() {
            document.getElementById('network-loading').style.display = 'block';
            document.getElementById('network-list').innerHTML = '';
            loadNetwork();
        }

        function editNetworkConfig(id, key) {
            document.getElementById(`network-display-${id}`).style.display = 'none';
            document.getElementById(`network-input-${id}`).style.display = 'block';
            document.getElementById(`network-edit-buttons-${id}`).style.display = 'flex';
            document.getElementById(`network-${id}`).classList.add('editing');
        }

        function cancelNetworkEdit(id) {
            document.getElementById(`network-display-${id}`).style.display = 'block';
            document.getElementById(`network-input-${id}`).style.display = 'none';
            document.getElementById(`network-edit-buttons-${id}`).style.display = 'none';
            document.getElementById(`network-${id}`).classList.remove('editing');
        }

        async function saveNetworkConfig(id, key) {
            const newValue = document.getElementById(`network-input-${id}`).value;
            try {
                // Verwende den neuen /settings Endpoint f√ºr SOCKS5 Proxy
                const response = await fetch(`${API_URL}/admin/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [key]: newValue })
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    document.getElementById(`network-display-${id}`).textContent = newValue || '(nicht konfiguriert - direkte Verbindung)';
                    cancelNetworkEdit(id);
                    showSuccess(`Netzwerk-Konfiguration '${key}' aktualisiert!`, 'network-message');
                    // Cache wird automatisch invalidiert
                } else {
                    showError(`Fehler beim Speichern: ${result.error}`, 'network-message');
                }
            } catch (error) {
                showError(`Fehler beim Speichern: ${error.message}`, 'network-message');
            }
        }

        async function testProxyConnection() {
            const btn = document.querySelector('button[onclick="testProxyConnection()"]');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'üîç Teste...';

                const response = await fetch(`${API_URL}/admin/test-proxy`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showSuccess(`‚úÖ Proxy-Verbindung erfolgreich! (${result.message})`);
                } else {
                    showError(`‚ùå Proxy-Test fehlgeschlagen: ${result.message}`);
                }
            } catch (error) {
                showError(`‚ùå Proxy-Test-Fehler: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function checkExternalIPs() {
            const resultDiv = document.getElementById('ip-check-result');
            resultDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/admin/test-proxy`, {
                    method: 'POST'
                });

                const data = await response.json();

                document.getElementById('direct-ip').textContent = data.direct_ip || 'N/A';
                document.getElementById('proxied-ip').textContent = data.proxied_ip || 'N/A';
                document.getElementById('proxy-latency').textContent = data.latency_ms || '-';

                const status = document.getElementById('proxy-status');
                if (data.proxy_working) {
                    status.textContent = '‚úÖ Proxy aktiv';
                    status.style.color = 'green';
                } else {
                    status.textContent = '‚ùå Proxy nicht aktiv';
                    status.style.color = 'red';
                }

                resultDiv.style.display = 'block';
            } catch (error) {
                showError(`‚ùå Fehler beim Abrufen der IPs: ${error.message}`);
            }
        }

        // SOCKS5 Proxy Management Functions
        async function loadSocks5Status() {
            try {
                const configs = await fetchJSON(`${API_URL}/admin/config`);
                const enabledConfig = configs.find(config => config.key === 'socks5_enabled');
                const hostConfig = configs.find(config => config.key === 'socks5_host');
                const portConfig = configs.find(config => config.key === 'socks5_port');
                const userConfig = configs.find(config => config.key === 'socks5_user');
                const passConfig = configs.find(config => config.key === 'socks5_pass');

                const statusSpan = document.getElementById('socks5-status');
                const toggleBtn = document.getElementById('socks5-toggle-btn');

                const isEnabled = enabledConfig && enabledConfig.value === 'true';
                const hasConfig = hostConfig && hostConfig.value && userConfig && userConfig.value && passConfig && passConfig.value;

                if (isEnabled && hasConfig) {
                    statusSpan.textContent = '‚úÖ Aktiv';
                    statusSpan.style.cssText = 'padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #d4edda; color: #155724;';
                    toggleBtn.textContent = 'üîÑ Deaktivieren';
                    toggleBtn.style.display = 'inline-block';
                } else if (hasConfig) {
                    statusSpan.textContent = '‚ö†Ô∏è Konfiguriert (inaktiv)';
                    statusSpan.style.cssText = 'padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #fff3cd; color: #856404;';
                    toggleBtn.textContent = 'üîÑ Aktivieren';
                    toggleBtn.style.display = 'inline-block';
                } else {
                    statusSpan.textContent = '‚ùå Nicht konfiguriert';
                    statusSpan.style.cssText = 'padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #f8d7da; color: #721c24;';
                    toggleBtn.textContent = '‚öôÔ∏è Konfigurieren';
                    toggleBtn.style.display = 'inline-block';
                }

                // Fill form fields if config exists
                if (hostConfig && hostConfig.value) document.getElementById('socks5-host').value = hostConfig.value;
                if (portConfig && portConfig.value) document.getElementById('socks5-port').value = portConfig.value;
                if (userConfig && userConfig.value) document.getElementById('socks5-user').value = userConfig.value;
                if (passConfig && passConfig.value) document.getElementById('socks5-pass').value = passConfig.value;

            } catch (error) {
                console.error('Failed to load SOCKS5 status:', error);
                document.getElementById('socks5-status').textContent = '‚ùå Fehler';
                document.getElementById('socks5-status').style.cssText = 'padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #f8d7da; color: #721c24;';
            }
        }

        async function toggleSocks5Proxy() {
            try {
                const configs = await fetchJSON(`${API_URL}/admin/config`);
                const enabledConfig = configs.find(config => config.key === 'socks5_enabled');
                const hostConfig = configs.find(config => config.key === 'socks5_host');
                const userConfig = configs.find(config => config.key === 'socks5_user');
                const passConfig = configs.find(config => config.key === 'socks5_pass');

                const hasConfig = hostConfig && hostConfig.value && userConfig && userConfig.value && passConfig && passConfig.value;
                const isEnabled = enabledConfig && enabledConfig.value === 'true';

                if (!hasConfig) {
                    // Show configuration form
                    document.getElementById('socks5-config-section').style.display = 'block';
                    document.getElementById('socks5-toggle-btn').style.display = 'none';
                    return;
                }

                // Toggle enabled/disabled
                const newEnabled = !isEnabled;

                const response = await fetch(`${API_URL}/admin/configure-socks5`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: newEnabled,
                        host: hostConfig.value,
                        port: parseInt(configs.find(config => config.key === 'socks5_port')?.value || '1080'),
                        username: userConfig.value,
                        password: passConfig.value
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showSuccess(`${newEnabled ? '‚úÖ SOCKS5 Proxy aktiviert' : '‚ùå SOCKS5 Proxy deaktiviert'} - Container-Neustart erforderlich!`);
                    await loadSocks5Status(); // Refresh status
                } else {
                    showError(`‚ùå Fehler: ${result.message}`);
                }

            } catch (error) {
                showError(`‚ùå Fehler beim Umschalten: ${error.message}`);
            }
        }

        async function saveSocks5Config() {
            const host = document.getElementById('socks5-host').value.trim();
            const port = parseInt(document.getElementById('socks5-port').value);
            const username = document.getElementById('socks5-user').value.trim();
            const password = document.getElementById('socks5-pass').value.trim();

            if (!host || !username || !password) {
                showError('‚ùå Host, Benutzername und Passwort sind erforderlich');
                return;
            }

            if (isNaN(port) || port < 1 || port > 65535) {
                showError('‚ùå Ung√ºltiger Port (1-65535)');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/configure-socks5`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: true,
                        host: host,
                        port: port,
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showSuccess('‚úÖ SOCKS5 Proxy konfiguriert! F√ºhren Sie jetzt den Container-Neustart aus.');
                    document.getElementById('socks5-config-section').style.display = 'none';
                    document.getElementById('socks5-toggle-btn').style.display = 'inline-block';

                    // Zeige Restart-Anweisung
                    setTimeout(() => {
                        alert('Container-Neustart erforderlich!\n\nF√ºhren Sie folgenden Befehl aus:\n\ndocker compose restart pbarr\n\nDanach wird SOCKS5 aktiv.');
                    }, 500);

                } else {
                    showError(`‚ùå Fehler: ${result.message}`);
                }

            } catch (error) {
                showError(`‚ùå Fehler beim Speichern: ${error.message}`);
            }
        }

        function cancelSocks5Config() {
            document.getElementById('socks5-config-section').style.display = 'none';
            document.getElementById('socks5-toggle-btn').style.display = 'inline-block';
        }

        // Container Restart Function
        async function restartContainer() {
            if (!confirm('Container wirklich neu starten? Dies stoppt die Anwendung tempor√§r.')) {
                return;
            }

            const btn = document.querySelector('button[onclick="restartContainer()"]');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'üîÑ Starte neu...';

                const response = await fetch(`${API_URL}/admin/system/restart`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showSuccess('‚úÖ Container-Neustart wurde eingeleitet. Seite wird neu geladen...');
                    // Reload page after 3 seconds to allow restart
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showError(`‚ùå Neustart fehlgeschlagen: ${result.message}`);
                }
            } catch (error) {
                showError(`‚ùå Fehler beim Neustart: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Load on init
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadVersion();
            loadConfigs();
            loadDownloads();
            loadNetwork();
            loadModules();
            loadSeries(); // Load series list
            loadCurrentLogLevel(); // Load current log level
            loadLogs(); // Load initial logs
            loadSonarrConfig(); // Load saved Sonarr config
            checkSonarrStatus(); // Check Sonarr integration status

            // Auto-refresh every 30 seconds
            setInterval(loadDashboard, 30000);

            // Close modal when clicking outside
            window.onclick = (event) => {
                const modals = ['addConfigModal', 'editSeriesFiltersModal', 'addSeriesModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };
        });
    </script>
</body>
</html>
